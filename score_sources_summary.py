#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""评分来源检查清单"""

print("=" * 70)
print("综合评分来源检查清单")
print("=" * 70)

sources = [
    {
        "来源": "perform_analysis (单个股票分析)",
        "位置": "11586-11604行",
        "计算方式": "三者加权平均 (0.3*短期_1_10 + 0.4*中期_1_10 + 0.3*长期_1_10)",
        "数据类型": "原始分数(-8~+8) → 转换为1-10分 → 加权",
        "状态": "✓ 已修复"
    },
    {
        "来源": "get_stock_score_for_batch (批量快速评分)",
        "位置": "3479行",
        "计算方式": "三者加权平均 (0.3*短期_1_10 + 0.4*中期_1_10 + 0.3*长期_1_10)",
        "数据类型": "原始分数(-8~+8) → 转换为1-10分 → 加权",
        "状态": "✓ 已修复"
    },
    {
        "来源": "format_investment_advice (投资建议格式化)",
        "位置": "10729-10732行",
        "计算方式": "三者加权平均 (0.3*短期_1_10 + 0.4*中期_1_10 + 0.3*长期_1_10)",
        "数据类型": "原始分数(-8~+8) → 转换为1-10分 → 加权",
        "状态": "✓ 已修复"
    },
    {
        "来源": "generate_comprehensive_prediction (综合预测生成)",
        "位置": "3895行 (第一次)",
        "计算方式": "三者加权平均 (0.3*短期 + 0.4*中期 + 0.3*长期)",
        "数据类型": "1-10分制 (已是最终形式)",
        "状态": "✓ 已修复 (从简单平均改为加权平均)"
    },
    {
        "来源": "generate_comprehensive_prediction (兜底方案)",
        "位置": "3938行 (第二次)",
        "计算方式": "三者加权平均 (0.3*短期 + 0.4*中期 + 0.3*长期)",
        "数据类型": "1-10分制 (已是最终形式)",
        "状态": "✓ 已修复 (从简单平均改为加权平均)"
    },
    {
        "来源": "calculate_comprehensive_score_for_display (显示用评分)",
        "位置": "10180-10186行",
        "计算方式": "三者加权平均 (0.3*短期 + 0.4*中期 + 0.3*长期)",
        "数据类型": "1-10分制 (已转换)",
        "状态": "✓ 已修复"
    },
    {
        "来源": "perform_detailed_analysis (详细分析-缓存数据)",
        "位置": "13485-13489行",
        "计算方式": "三者加权平均 (0.3*短期 + 0.4*中期 + 0.3*长期)",
        "数据类型": "1-10分制 (从缓存读取)",
        "状态": "✓ 已修复"
    },
    {
        "来源": "format_recommendation_index (推荐指数)",
        "位置": "16198-16201行",
        "计算方式": "三者加权平均 (0.3*短期 + 0.4*中期 + 0.3*长期)",
        "数据类型": "1-10分制 (已转换)",
        "状态": "✓ 已修复"
    },
    {
        "来源": "CSV导入 (批量导入)",
        "位置": "4049行",
        "计算方式": "从batch_scores直接读取 (这些是通过get_stock_score_for_batch计算的)",
        "数据类型": "1-10分制 (已计算)",
        "状态": "✓ 使用get_stock_score_for_batch的结果 (已修复)"
    },
    {
        "来源": "推荐系统 (快速推荐)",
        "位置": "3464-3486行",
        "计算方式": "三者加权平均 (0.3*短期_1_10 + 0.4*中期_1_10 + 0.3*长期_1_10)",
        "数据类型": "原始分数(-8~+8) → 转换为1-10分 → 加权",
        "状态": "✓ 已修复"
    }
]

print("\n" + "=" * 70)
print("所有评分来源统计")
print("=" * 70)
print()

for i, source in enumerate(sources, 1):
    print(f"[{i}] {source['来源']}")
    print(f"    位置: {source['位置']}")
    print(f"    计算: {source['计算方式']}")
    print(f"    数据: {source['数据类型']}")
    print(f"    状态: {source['状态']}")
    print()

print("=" * 70)
print("关键结论")
print("=" * 70)
print("""
✓ 所有综合评分都源于三者的加权平均
✓ 权重分配: 短期30% + 中期40% + 长期30%
✓ 没有直接读取或单独计算的情况
✓ 修复前: 部分地方使用了简单平均(1/3 + 1/3 + 1/3)或错误的双重转换
✓ 修复后: 所有地方都统一使用正确的加权平均公式

修复的关键地方:
1. 3895行和3938行: overall_score从简单平均改为加权平均
2. 其他所有地方: 已确认使用正确的加权平均计算

现在综合评分的计算是一致和正确的！
""")
print("=" * 70)
