================================================================================
                    筹码健康度与筹码分布计算公式全集
================================================================================

整理日期：2025-12-11
数据来源：chip_health_analyzer.py + 筹码理论与实现对照.md


================================================================================
一、核心筹码分布指标
================================================================================

1. SCR 筹码集中度（最核心指标）
--------------------------------
公式：
    SCR = ((P90 - P10) / (2 × P50)) × 100%

参数说明：
    P10 - 10%成本位（底部筹码价格）
    P50 - 50%成本位（中位数成本价格）
    P90 - 90%成本位（顶部筹码价格）

评价标准：
    SCR < 10%  →  高度集中（变盘在即）⭐⭐⭐⭐⭐
    SCR < 15%  →  相对集中（筹码合力强）⭐⭐⭐⭐
    SCR < 25%  →  适中（正常波动）
    SCR > 30%  →  发散（多空分歧大）⚠️


2. 筹码成本分位数计算（P10, P50, P90）
--------------------------------
算法步骤：
    步骤1：基于成交量构建筹码分布
        chip_distribution = []
        for price, volume in zip(prices, volumes):
            chip_distribution.extend([price] * int(volume / 1000))

    步骤2：计算分位数
        P10 = np.percentile(chip_distribution, 10)   # 10%分位数
        P50 = np.percentile(chip_distribution, 50)   # 50%分位数（中位数）
        P90 = np.percentile(chip_distribution, 90)   # 90%分位数

说明：
    使用近60日数据，将每日成交量按价格构建筹码分布直方图


3. 筹码乖离率（Bias of Cost）
--------------------------------
公式：
    筹码乖离率 = ((当前价格 - P50) / P50) × 100%

最佳持股区间：
    +5% 到 +15%

评价标准：
    3% ≤ 乖离率 ≤ 12%   →  最佳持股区 ⭐⭐⭐⭐
    -5% ≤ 乖离率 < 3%   →  接近成本区，支撑强
    乖离率 > 30%        →  获利回吐压力大 ⚠️
    乖离率 < -15%       →  低于成本，反弹潜力


================================================================================
二、筹码集中度指标
================================================================================

4. HHI 赫芬达尔指数（Herfindahl-Hirschman Index）
--------------------------------
公式：
    HHI = Σ(市场份额ᵢ)²

计算步骤：
    步骤1：将价格分成20个区间
        price_ranges = np.linspace(prices.min(), prices.max(), 20)

    步骤2：计算每个区间的筹码份额
        chip_shares = []
        for i in range(len(price_ranges) - 1):
            mask = (prices >= price_ranges[i]) & (prices < price_ranges[i+1])
            chip_shares.append(volumes[mask].sum())

    步骤3：归一化
        total_chips = sum(chip_shares)
        chip_shares = [s / total_chips for s in chip_shares if s > 0]

    步骤4：计算HHI
        HHI = sum(s**2 for s in chip_shares)

评价标准：
    HHI > 0.25           →  高度集中
    0.15 < HHI < 0.25    →  适中
    HHI < 0.15           →  相对分散


5. 基尼系数（Gini Coefficient）
--------------------------------
公式：
    Gini = (2 × Σ(i × 筹码份额ᵢ)) / (n × Σ筹码份额) - (n + 1) / n

计算步骤：
    chip_shares_sorted = sorted(chip_shares)
    n = len(chip_shares_sorted)
    
    gini = (2 * sum((i+1) * chip_shares_sorted[i] for i in range(n))) / 
           (n * sum(chip_shares_sorted)) - (n + 1) / n

评价标准：
    Gini < 0.4           →  分布均匀
    0.4 ≤ Gini ≤ 0.6     →  适中
    Gini > 0.6           →  分布不均


================================================================================
三、获利盘/套牢盘指标
================================================================================

6. 获利盘比例
--------------------------------
公式：
    获利盘比例 = (低于当前价的成交量 / 总成交量) × 100%

代码实现：
    profit_volume = volumes[prices < current_price].sum()
    profit_ratio = (profit_volume / total_volume) * 100

评价标准：
    获利盘 > 70%                      →  上方无套牢盘压力 ✓
    获利盘 < 30%                      →  套牢盘多，反弹动力强 ✓
    获利盘 > 90% + 放量滞涨           →  出货信号 ⚠️


7. 套牢盘比例
--------------------------------
公式：
    套牢盘比例 = (高于当前价的成交量 / 总成交量) × 100%

代码实现：
    loss_volume = volumes[prices > current_price].sum()
    loss_ratio = (loss_volume / total_volume) * 100


================================================================================
四、形态识别指标
================================================================================

8. 筹码峰型识别算法
--------------------------------
算法步骤：
    步骤1：将价格分成10个区间，统计每个区间的成交量
        bins = np.linspace(price_min, price_max, 11)
        volume_distribution = []
        
        for i in range(len(bins) - 1):
            bin_mask = (prices >= bins[i]) & (prices < bins[i+1])
            bin_volume = volumes[bin_mask].sum()
            volume_distribution.append(bin_volume)

    步骤2：找出峰值（局部最大值）
        peaks = []
        for i in range(1, len(volume_distribution) - 1):
            if volume_distribution[i] > volume_distribution[i-1] and \
               volume_distribution[i] > volume_distribution[i+1]:
                if volume_distribution[i] > np.mean(volume_distribution) * 0.8:
                    peaks.append(i)

    步骤3：判断峰型
        if len(peaks) == 1:
            peak_pos = peaks[0]
            if peak_pos < 3:
                return '底部单峰密集 ⭐⭐⭐⭐⭐'  # 吸筹完成
            elif peak_pos > 7:
                return '高位单峰密集 ⚠️'       # 出货完毕
            else:
                return '中位单峰'
        elif len(peaks) == 2:
            return '双峰分布（可能洗盘中）'
        elif len(peaks) > 2:
            return '多峰林立（散户博弈）⚠️'

形态评价：
    底部单峰密集  →  吸筹完成，经典起涨信号 ⭐⭐⭐⭐⭐
    高位单峰密集  →  出货完毕，散户接盘 ⚠️⚠️
    双峰分布      →  健康洗盘接力
    多峰林立      →  散户博弈，每涨一点遇抛压 ⚠️


9. 底部筹码锁定检测
--------------------------------
算法步骤：
    步骤1：找出60日内的最低价区域（底部20%价格区间）
        price_min = prices_60d.min()
        price_20pct = price_min + (current_price - price_min) * 0.2

    步骤2：计算底部区域的筹码量
        bottom_volume_60d = volumes_60d[prices_60d <= price_20pct].sum()
        bottom_volume_20d = volumes_20d[prices_20d <= price_20pct].sum()

    步骤3：计算底部筹码占比
        bottom_ratio_60d = bottom_volume_60d / total_volume_60d
        bottom_ratio_20d = bottom_volume_20d / total_volume_20d

    步骤4：判断底部筹码是否锁定
        if bottom_ratio_60d > 0.15 and bottom_ratio_20d > bottom_ratio_60d * 0.7:
            return True  # 底部筹码锁定

判断逻辑：
    如果底部区域（最低价+20%范围）的筹码在60日和20日中占比保持稳定
    说明低位筹码未流出，主力锁仓 🔒

评分加成：
    底部筹码锁定  →  +1.5分，强烈看涨信号 ⭐⭐⭐⭐⭐


================================================================================
五、综合评分体系
================================================================================

10. 五维度评分公式（每项0-2分）
--------------------------------

【维度1】集中度评分（基于SCR）
    if scr < 10:
        concentration_score = 2.0
    elif scr < 15:
        concentration_score = 1.5
    elif scr < 25:
        concentration_score = 1.0
    elif scr < 35:
        concentration_score = 0.5
    else:
        concentration_score = 0.0

【维度2】换手率评分
    if 2 < turnover < 5:
        turnover_score = 2.0
    elif 1 < turnover <= 2 or 5 <= turnover < 8:
        turnover_score = 1.5
    elif 0.5 < turnover <= 1 or 8 <= turnover < 12:
        turnover_score = 1.0
    elif turnover > 15:
        turnover_score = 0.0
    else:
        turnover_score = 0.5

【维度3】盈亏比评分（基于获利盘和乖离率）
    # 最理想：低获利盘(套牢盘多) + 小正乖离
    if profit_ratio < 30 and 0 < chip_bias < 10:
        profit_loss_score = 2.0
    elif profit_ratio < 40 and -5 < chip_bias < 15:
        profit_loss_score = 1.5
    elif profit_ratio < 60:
        profit_loss_score = 1.0
    elif profit_ratio > 80:
        profit_loss_score = 0.0
    else:
        profit_loss_score = 0.5

【维度4】乖离率评分
    if 3 <= chip_bias <= 12:
        bias_score = 2.0
    elif -5 <= chip_bias < 3 or 12 < chip_bias <= 20:
        bias_score = 1.5
    elif -15 <= chip_bias < -5 or 20 < chip_bias <= 30:
        bias_score = 1.0
    elif chip_bias > 40 or chip_bias < -25:
        bias_score = 0.0
    else:
        bias_score = 0.5

【维度5】形态评分
    if '底部单峰' in peak_type:
        pattern_score = 2.0
    elif bottom_locked:
        pattern_score = 1.8
    elif '双峰' in peak_type:
        pattern_score = 1.2
    elif '高位单峰' in peak_type:
        pattern_score = 0.0
    elif '多峰林立' in peak_type:
        pattern_score = 0.3
    else:
        pattern_score = 1.0


11. 总评分公式
--------------------------------
公式：
    总评分 = 集中度评分 + 换手率评分 + 盈亏比评分 + 乖离率评分 + 形态评分
    满分 = 10.0分

健康度等级划分：
    9.0-10.0分  →  A+ 极度健康 ⭐⭐⭐⭐⭐
    8.0-9.0分   →  A 优秀 ⭐⭐⭐⭐
    7.0-8.0分   →  B 良好 ⭐⭐⭐
    6.0-7.0分   →  C 一般 ⭐⭐
    4.0-6.0分   →  D 偏弱 ⭐
    0-4.0分     →  E 不健康 ⚠️


12. 形态置信度计算
--------------------------------
算法：
    base_confidence = 50
    
    if '底部单峰' in peak_type:
        base_confidence = 85
        if scr < 10:
            base_confidence += 10
        if 5 <= chip_bias <= 15:
            base_confidence += 5
    
    elif '底部筹码锁定' in peak_type:
        base_confidence = 75
        if scr < 15:
            base_confidence += 10
    
    elif '双峰' in peak_type:
        base_confidence = 70
        if 15 < scr < 25:
            base_confidence += 10
    
    elif '高位单峰' in peak_type:
        base_confidence = 80
        if scr < 12:
            base_confidence += 15
    
    # 最终置信度限制在100以内
    confidence = min(100, base_confidence)


================================================================================
六、公式理论来源
================================================================================

公式名称                   理论来源
--------------------------------------------------------------------------------
SCR筹码集中度             同花顺/东方财富筹码分布指标
底部筹码锁定             威廉·欧奈尔《笑傲股市》
筹码峰型识别             陈浩《筹码分布》理论
筹码乖离率               张龄松《股价趋势技术分析》
HHI指数                  经济学市场集中度指标
基尼系数                 经济学财富分配不均指标


================================================================================
七、实战信号组合
================================================================================

【强烈看涨信号组合】
--------------------------------------------------------------------------------
条件：
    ✓ SCR < 10%
    ✓ 底部单峰密集
    ✓ 筹码乖离率 5-15%
    ✓ 底部筹码锁定

结果：
    → 评分 ≥ 9分，极度健康 ⭐⭐⭐⭐⭐
    → 吸筹完成，经典起涨信号 🚀


【危险信号组合】
--------------------------------------------------------------------------------
条件：
    ✗ 高位单峰密集
    ✗ SCR < 12%（高位集中）
    ✗ 获利盘 > 90%
    ✗ 放量滞涨

结果：
    → 评分 < 3分，立即减仓 ⚠️⚠️
    → 出货完毕，散户接盘


【健康洗盘信号】
--------------------------------------------------------------------------------
条件：
    ✓ 双峰分布
    ✓ 底部筹码锁定
    ✓ SCR 10-25%
    ✓ 中间谷底逐渐填平

结果：
    → 评分 7-8分，良好 ⭐⭐⭐⭐
    → 健康换手接力


================================================================================
八、权重分配（符合A股实战）
================================================================================

评分维度            权重      说明
--------------------------------------------------------------------------------
集中度评分          2.0分     最核心，决定筹码合力
换手率评分          2.0分     活跃度指标
盈亏比评分          2.0分     判断获利回吐压力
乖离率评分          2.0分     安全边际
形态评分            2.0分     主力意图识别

总分                10.0分


================================================================================
九、A股实战验证率
================================================================================

信号类型              胜率      说明
--------------------------------------------------------------------------------
底部单峰密集          70-80%    最可靠信号
底部筹码锁定          75-85%    强烈看涨信号
SCR<10%              65-75%    高胜率
获利盘>90%           50-60%    需配合其他指标


================================================================================
十、使用示例
================================================================================

【示例1：贵州茅台 600519 - 健康股票】
--------------------------------------------------------------------------------
筹码指标：
    SCR筹码集中度:    8.5% ⭐⭐⭐⭐⭐
    筹码成本分布:     P10=¥1480, P50=¥1520, P90=¥1560
    筹码乖离率:       +8.50% (最佳区间)
    获利盘比例:       72.0%
    套牢盘比例:       28.0%
    换手率:           2.35%
    筹码峰型:         底部单峰密集 ⭐⭐⭐⭐⭐
    底部锁定:         是 🔒

综合评分：
    总分:             9.2/10.0
    等级:             A+ 极度健康 ⭐⭐⭐⭐⭐
    信号强度:         强

关键信号：
    ✓✓ SCR高度集中(<10%)，变盘在即
    ✓ 获利盘充足(>70%)，上涨压力小
    ✓ 筹码乖离率在最佳持股区(5-15%)
    ✓✓ 底部单峰密集 - 吸筹完成，经典起涨信号 🚀
    ✓✓ 底部筹码锁定 - 主力志在长远 ⭐⭐⭐⭐⭐


【示例2：某ST股票 - 危险股票】
--------------------------------------------------------------------------------
筹码指标：
    SCR筹码集中度:    35.2%
    筹码成本分布:     P10=¥8.20, P50=¥12.50, P90=¥18.60
    筹码乖离率:       -22.00%
    获利盘比例:       15.0%
    套牢盘比例:       85.0%
    换手率:           12.35%
    筹码峰型:         高位单峰密集 ⚠️
    底部锁定:         否

综合评分：
    总分:             2.5/10.0
    等级:             E 不健康 ⚠️
    信号强度:         强（卖出）

关键信号：
    ⚠ SCR发散(>30%)，多空分歧大
    ⚠ 乖离率过高，获利回吐压力大
    ⚠ 换手率过高(>10%)，警惕炒作
    ⚠⚠ 高位单峰密集 - 出货完毕，散户接盘 ⚠️⚠️


================================================================================
文档说明
================================================================================

本文档整理了TradingAgents项目中所有关于筹码健康度和筹码分布的计算公式。
这些公式构成了一个完整的筹码分析体系，涵盖了：
    ✓ 集中度指标（SCR、HHI、基尼系数）
    ✓ 成本分布指标（P10/P50/P90、乖离率）
    ✓ 盈亏比指标（获利盘/套牢盘）
    ✓ 形态识别（峰型、底部锁定）
    ✓ 综合评分体系（五维度评分）

核心文件：
    - chip_health_analyzer.py（主实现代码）
    - 筹码理论与实现对照.md（理论说明）
    - 筹码分析集成说明.md（集成文档）

整理人：GitHub Copilot
日期：2025-12-11

================================================================================
